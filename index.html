<!doctype html>
<html lang="en">
    <head>
        <script src="https://unpkg.com/vue@3.0.5"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"></link>
        <link rel="stylesheet" href="noter.css"></link>
    </head>
    <body>
        <div id="app">
            <div class="container">

                <div class="row" v-if="!loggedin">
                    <div class="col-md-4" id="login">
                        <h4>Login:</h4>
                        <label for="loginusername">Username:</label><br>
                        <input type="text" id="loginusername" name="loginusername" v-model="loginusername"><br>
                        <label for="loginpassword">Password:</label><br>
                        <input type="text" id="loginpassword" name="loginpassword" v-model="loginpassword"><br>
                        <button v-on:click="login">Login</button>
                    </div>
                    <div class="col-md-4" id="register">
                        <h4>Register:</h4>
                        <label for="registerusername">Username:</label><br>
                        <input type="text" id="registerusername" name="registerusername" v-model="registerusername"><br>
                        <label for="registerpassword">Password:</label><br>
                        <input type="text" id="registerpassword" name="registerpassword" v-model="registerpassword"><br>
                        <label for="registerpassword2">Confirm Password:</label><br>
                        <input type="text" id="registerpassword2" name="registerpassword2" v-model="registerpassword2"><br>
                        <button v-on:click="register">Register</button>
                    </div>
                </div>
                <div class="row" v-if="!loggedin">
                    <p>{{ warning }}</p>
                </div>

                <div class="row" v-if="loggedin">

                    <div class="col-md-1" id="year">
                        <h4>Year:</h4>
                        <div v-for="yearobj in years">
                            <button v-on:click="show_months(yearobj)">{{ yearobj.year }}</button>
                            <br>
                        </div>
                    </div>
                    <div class="col-md-2" id="month">
                        <h4>Month:</h4>
                        <div v-for="month in months">
                            <button v-on:click="fill_calendar(month)">{{ translate_month(month) }}</button>
                            <br>
                        </div>
                    </div>
                    <div class="col-md-8" id="default" v-if="defaultview">
                        <h1>Welcome to Noter!</h1>
                        <div id="createnote-button">
                            <button v-on:click="render_notes(true, 'NO DATE')">Create new note for today</button>
                        </div>
                    </div>
                    <div class="col-md-8" id="days-calendar" v-if="calendarview && !defaultview">
                        <div id="days-calendar">
                            <h4>{{ translate_month(selectedmonth) }} {{ selectedyear }}</h4>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col">Sunday</th>
                                        <th scope="col">Monday</th>
                                        <th scope="col">Tuesday</th>
                                        <th scope="col">Wednesday</th>
                                        <th scope="col">Thursday</th>
                                        <th scope="col">Friday</th>
                                        <th scope="col">Saturday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1])" v-if="calendarlinks[i-1] !== ''">{{ calendarlinks[i-1] }}</button>
                                    </td></tr>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1+7] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1+7])" v-if="calendarlinks[i-1+7] !== ''">{{ calendarlinks[i-1+7] }}</button>
                                    </td></tr>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1+14] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1+14])" v-if="calendarlinks[i-1+14] !== ''">{{ calendarlinks[i-1+14] }}</button>
                                    </td></tr>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1+21] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1+21])" v-if="calendarlinks[i-1+21] !== ''">{{ calendarlinks[i-1+21] }}</button>
                                    </td></tr>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1+28] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1+28])" v-if="calendarlinks[i-1+28] !== ''">{{ calendarlinks[i-1+28] }}</button>
                                    </td></tr>
                                    <tr><td v-for="i in 7">
                                        {{ calendardays[i-1+35] }}
                                        <button v-on:click="render_notes(false, calendardays[i-1+35])" v-if="calendarlinks[i-1+35] !== ''">{{ calendarlinks[i-1+35] }}</button>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                        <br>
                        <div id="createnote-button">
                            <button v-on:click="render_notes(true, 'NO DATE')">Create new note for today</button>
                        </div>
                    </div>
                    <div class="col-md-8" id="notes" v-if="!calendarview && !defaultview">
                        <h4>{{ selectedday }} {{ translate_month(selectedmonth) }} {{ selectedyear }} Notes:</h4>
                        <div id="createnote-button" v-if="itistoday()">
                            <button v-on:click="render_notes(true, 'NO DATE')">Create new note for today</button>
                            <br>
                        </div>
                        <div v-for="noteobj in notes">
                            <div v-bind:id="noteobj.note_num">
                                <label for="title">Write title here:</label><br>
                                <input type="text" id="title" name="title" v-model="noteobj.title"><br>
                                <label for="note">Write note here:</label><br>
                                <textarea id="note" name="note" rows="4" cols="50" v-model="noteobj.note">
                                    {{ noteobj.note }}
                                </textarea><br>
                                <button v-on:click="save_note(noteobj.note_num, noteobj.title, noteobj.note)">Save Note</button><br>
                                <button v-on:click="delete_note(noteobj.note_num)">Delete Note</button>
                            </div>
                            <br>
                        </div>
                    </div>
                    <div class="col-md-1" id="logout">
                        <p>Hi: <b>{{ curruser }}</b></p>
                        <button v-on:click="logout">Logout</button>
                    </div>

                </div>
            </div>
        </div>

        <script>
            const app = Vue.createApp({
                data: function() {
                    return {
                        curruser: "",
                        loggedin: false,
                        loginusername: "",
                        loginpassword: "",
                        registerusername: "",
                        registerpassword: "",
                        registerpassword2: "",
                        warning: "",
                        defaultview: true,
                        calendarview: false,
                        display_div_all: false,
                        months: [],
                        years: [],
                        notes: [],
                        calendardays: new Array(42).fill("-"),
                        calendarlinks: new Array(42).fill(""),
                        selectedyear: "",
                        selectedmonth: "",
                        selectedday: "",
                    }
                },
                methods: {
                    resetvariables: function() {
                        this.curruser = "";
                        this.loggedin = false;
                        this.loginusername = "";
                        this.loginpassword = "";
                        this.registerusername = "";
                        this.registerpassword = "";
                        this.registerpassword2 = "";
                        this.warning = "";
                        this.defaultview = true;
                        this.calendarview = false;
                        this.display_div_all = false;
                        this.months = [];
                        this.years = [];
                        this.notes = [];
                        this.calendardays = new Array(42).fill("-");
                        this.calendarlinks = new Array(42).fill("");
                        this.selectedyear = "";
                        this.selectedmonth = "";
                        this.selectedday = "";
                    },
                    login: async function() {
                        let formData = new FormData();
                        formData.append("user", this.loginusername);
                        //fetch('https://wujames-noter.herokuapp.com/login/',
                        fetch('http://127.0.0.1:8000/login/',
                            {
                                body: formData,
                                method: "POST"
                            })
                            .then(response => response.json())
                            .then(json => {
                                if (json["user_exists"]) {
                                    console.log(this.loginpassword + json['salt']);
                                    let hashpassword = "" + this.stringToHash(this.loginpassword + json['salt']);
                                    console.log(hashpassword);
                                    if (hashpassword === json["password"]) {
                                        this.curruser = json["user"];
                                        this.loggedin = true;
                                        this.refresh_navbar();
                                    }
                                    else {
                                        this.warning = "Password incorrect";
                                    }
                                }
                                else {
                                    this.warning = "Username incorrect";
                                }
                            });
                    },
                    register: async function() {
                        if (this.registerusername === "" || this.registerpassword === "") {
                            this.warning = "Please do not leave the fields blank";
                            return;
                        }
                        if (this.registerpassword !== this.registerpassword2) {
                            this.warning = "Passwords do not match";
                            return;
                        }

                        let formData = new FormData();
                        formData.append("user", this.registerusername);
                        //let user_exists = await fetch('https://wujames-noter.herokuapp.com/userexists/',
                        let user_exists = await fetch('http://127.0.0.1:8000/userexists/',
                            {
                                body: formData,
                                method: "POST"
                            })
                            .then(response => response.json())
                            .then(json => {
                                return json["user_exists"];
                            });
                        if (user_exists) {
                            this.warning = "Username already exists";
                            return;
                        }

                        let saltstring = "" + Math.random();
                        let hashpassword = "" + this.stringToHash(this.registerpassword + saltstring);
                        console.log(this.registerpassword + saltstring);
                        console.log(hashpassword);
                        formData = new FormData();
                        formData.append("user", this.registerusername);
                        formData.append("password", hashpassword);
                        formData.append("salt", saltstring);
                        //fetch('https://wujames-noter.herokuapp.com/register/',
                        fetch('http://127.0.0.1:8000/register/',
                            {
                                body: formData,
                                method: "POST"
                            })
                            .then(response => response.json())
                            .then(json => {
                                this.curruser = json["user"];
                                this.loggedin = true;
                                this.refresh_navbar();
                                console.log(JSON.stringify(json))
                            });
                    },
                    logout: async function() {
                        //fetch('https://wujames-noter.herokuapp.com/logout/')
                        fetch('http://127.0.0.1:8000/logout/')
                            .then(response => response.json())
                            .then(json => {
                                this.resetvariables();
                            });
                    },
                    show_months: function(yearobj) {
                        this.selectedyear = yearobj["year"];
                        this.months = yearobj["months"];
                        // clicking on a year should go back to the default page
                        this.defaultview = true;
                    },
                    translate_month: function(month) {
                        let monthnames = {
                            "01": "Jan", "02": "Feb", "03": "Mar", "04": "Apr", "05": "May", "06": "Jun",
                            "07": "Jul", "08": "Aug", "09": "Sep", "10": "Oct", "11": "Nov", "12": "Dec"
                        };
                        return monthnames[month]
                    },
                    fill_calendar: async function(month) {
                        // reset calendar
                        this.defaultview = false;
                        this.calendarview = true;
                        this.calendardays = new Array(42).fill("-");
                        this.calendarlinks = new Array(42).fill("");
                        this.selectedmonth = month;
                        let yearandmonth = this.selectedyear + "-" + month;
                        console.log(yearandmonth);
                        
                        // from /getmonthdays, get days of given month and number of notes of each day
                        //fetch('https://wujames-noter.herokuapp.com/getmonthdays/' + yearandmonth + '/')
                        fetch('http://127.0.0.1:8000/getmonthdays/' + yearandmonth + '/')
                            .then(response => response.json())
                            .then(json => {
                                let firstdayselectedmonth = new Date(yearandmonth + "-01T00:00:00.000");
                                let offset = firstdayselectedmonth.getDay();
                                let days = json["monthdays"]["days"];

                                let day = 1;
                                for (let i = offset; i < 31 + offset; i++) {
                                    let daystring = day < 10 ? "0" + day : "" + day;
                                    this.calendardays[i] = daystring;
                                    if (days.hasOwnProperty(daystring)) {
                                        this.calendarlinks[i] = " " + days[daystring] + " notes";
                                    }
                                    day += 1;
                                }
                            });
                    },
                    itistoday: function() {
                        let today = new Date();
                        day = String(today.getDate()).padStart(2, "0");
                        month = String(today.getMonth() + 1).padStart(2, "0");
                        year = String(today.getFullYear());
                        console.log(year + "-" + month + "-" + day);
                        return day === this.selectedday && month === this.selectedmonth && year === this.selectedyear;
                    },
                    render_notes: async function(newnote, day) {
                        this.defaultview = false;
                        this.calendarview = false;
                        this.notes = [];
                        // clicking on a day should empty the months navbar
                        this.months = [];

                        let month = this.selectedmonth;
                        let year = this.selectedyear;
                        if (newnote) {
                            // create new note in database
                            //await fetch('https://wujames-noter.herokuapp.com/createnote/')
                            await fetch('http://127.0.0.1:8000/createnote/')
                                .then(response => response.json())
                                .then(json => {
                                    console.log(JSON.stringify(json));
                                });
                            
                            let today = new Date();
                            day = String(today.getDate()).padStart(2, "0");
                            month = String(today.getMonth() + 1).padStart(2, "0");
                            year = String(today.getFullYear());
                            this.selectedday = day;
                            this.selectedmonth = month;
                            this.selectedyear = year;

                            // get all notes for today, including the new note
                            let date = year + '-' + month + '-' + day;
                            //await fetch('https://wujames-noter.herokuapp.com/getnotes/' + date + '/')
                            await fetch('http://127.0.0.1:8000/getnotes/' + date + '/')
                                .then(response => response.json())
                                .then(json => {
                                    this.notes = json["notes"];
                                    console.log(this.notes);
                                });

                            // refresh navbar in case current year/month not in db
                            this.refresh_navbar();
                        }
                        else {
                            console.log("else");
                            this.selectedday = day;
                            let date = year + '-' + month + '-' + day;
                            //await fetch('https://wujames-noter.herokuapp.com/getnotes/' + date + '/')
                            await fetch('http://127.0.0.1:8000/getnotes/' + date + '/')
                                .then(response => response.json())
                                .then(json => {
                                    this.notes = json["notes"];
                                    console.log(this.notes);
                                });
                        }
                    },
                    save_note: async function(note_num, title, note) {
                        console.log(note_num);
                        console.log(title);
                        console.log(note);
                        let formData = new FormData();
                        console.log(this.selectedyear + "-" + this.selectedmonth + "-" + this.selectedday);
                        formData.append("user", this.curruser);
                        formData.append("date", this.selectedyear + "-" + this.selectedmonth + "-" + this.selectedday);
                        formData.append("note_num", note_num);
                        formData.append("title", title);
                        formData.append("note", note);
                        //fetch('https://wujames-noter.herokuapp.com/savenote/',
                        fetch('http://127.0.0.1:8000/savenote/',
                            {
                                body: formData,
                                method: 'POST'
                            })
                            .then(response => response.json())
                            .then(json => console.log(JSON.stringify(json)));
                    },
                    delete_note: async function(note_num) {
                        console.log(note_num);
                        let formData = new FormData();
                        console.log(this.selectedyear + "-" + this.selectedmonth + "-" + this.selectedday);
                        formData.append("user", this.curruser);
                        formData.append("date", this.selectedyear + "-" + this.selectedmonth + "-" + this.selectedday);
                        formData.append("note_num", note_num);
                        //fetch('https://wujames-noter.herokuapp.com/deletenote/',
                        fetch('http://127.0.0.1:8000/deletenote/',
                            {
                                body: formData,
                                method: 'POST'
                            })
                            .then(response => response.json())
                            .then(json => {
                                console.log("num_notes_left: " + json["num_notes_left"]);
                                // if all notes for the day deleted, go back to default screen
                                if (json["num_notes_left"] === 0) {
                                    this.defaultview = true;
                                    this.refresh_navbar();
                                }
                                // otherwise, just refresh notes screen
                                else {
                                    this.render_notes(false, this.selectedday);
                                }
                            });
                    },
                    refresh_navbar: async function() {
                        //fetch('https://wujames-noter.herokuapp.com/getyearsmonths/')
                        fetch('http://127.0.0.1:8000/getyearsmonths/')
                            .then(response => response.json())
                            .then((json) => {
                                this.years = [];
                                let yearsmonths = json["yearsmonths"];
                                for (let i = 0; i < yearsmonths.length; i++) {
                                    let yearobj = yearsmonths[i];
                                    this.years.push(yearobj);
                                }
                            });
                    },
                    // https://www.geeksforgeeks.org/how-to-create-hash-from-string-in-javascript/
                    stringToHash: function(string) {
                        var hash = 0;
                        if (string.length == 0) return hash;
                        for (i = 0; i < string.length; i++) {
                            char = string.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash;
                        }  
                        return hash;
                    }
                },
                // mounted() {
                //     this.refresh_navbar();
                // },
            })
            app.mount("#app");
        </script>
    </body>
</html>
